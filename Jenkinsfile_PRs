def RELEASE_ID
def TEST_STATUS = 0

/*
    pathmind-webapp pipeline
    The pipeline is made up of following steps
    1. Git clone and setup
    2. Build and local tests
    3. Publish Docker and Helm
    4. Optionally deploy to production and test
 */

/*
    Build a docker image
*/
def buildDockerImage(image_name) {
    echo "Building the pathmind Docker Image"
    sh "docker build -t base -f ${WORKSPACE}/Dockerfile-cache ${WORKSPACE}/"
    sh "docker build -t ${image_name} -f ${WORKSPACE}/Dockerfile ${WORKSPACE}/"
}

/*
    Build a docker image
*/
def createSecrets() {
    sh """
    set + x
    kubectl create secret generic dburl --from-literal DB_URL='jdbc:postgresql://postgres/pathminddb?user=pathminddb&password=Asdf1234' -n ${env.BUILD_NUMBER}
    kubectl create secret generic awsaccesskey --from-literal AWS_ACCESS_KEY_ID=${env.AWS_ACCESS_KEY_ID} -n ${env.BUILD_NUMBER}
    kubectl create secret generic awssecretaccesskey --from-literal AWS_SECRET_ACCESS_KEY=${env.AWS_SECRET_ACCESS_KEY} -n ${env.BUILD_NUMBER}
    kubectl create secret generic segmentwebsitekey --from-literal SEGMENT_WEBSITE_KEY=${env.SEGMENT_WEBSITE_KEY} -n ${env.BUILD_NUMBER}
    kubectl create secret generic segmentserversitekey --from-literal SEGMENT_SERVER_KEY=${env.SEGMENT_SERVER_KEY} -n ${env.BUILD_NUMBER}
    """
}

/*
    Publish a docker image
*/
def publishDockerImage(image_name, DOCKER_TAG) {
    echo "Logging to aws ecr"
    sh "aws ecr get-login --no-include-email --region us-east-1 | sh"
    echo "Creating ECR ${image_name}"
    sh "aws ecr create-repository --repository-name ${image_name}"
    echo "Tagging and pushing the pathmind Docker Image"
    sh "docker tag ${image_name} ${DOCKER_REG}/${image_name}:${DOCKER_TAG}"
    sh "docker push ${DOCKER_REG}/${image_name}"
}

/*
    Delete docker image
*/
def deleteDockerImage(image_name) {
    echo "Logging to aws ecr"
    sh "aws ecr get-login --no-include-email --region us-east-1 | sh"
    echo "Deleting ECR ${image_name}"
    sh "aws ecr delete-repository --repository-name ${image_name} --force"
}

/*
    This is the main pipeline section with the stages of the CI/CD
 */
pipeline {
    options {
        // Build auto timeout
        timeout(time: 1440, unit: 'MINUTES')
    }

    // Some global default variables
    environment {
        IMAGE_NAME = 'pathmind'
        DOCKER_REG = "839270835622.dkr.ecr.us-east-1.amazonaws.com"
        HELM_FILE = 'values_dev.yaml'
        HELM_FILE_UPDATER = 'values_dev-updater.yaml'
        DEPLOY_PROD = false
    }

    parameters {
        string(name: 'GIT_BRANCH', defaultValue: 'test', description: 'Git branch to build')
        booleanParam(name: 'DEPLOY_TO_PROD', defaultValue: false, description: 'If build and tests are good, proceed and deploy to production without manual approval')

    }

    //all is built and run from the master
    agent {
        node {
            label 'master'
            customWorkspace "${env.BUILD_NUMBER}"
        }
    }

    // Pipeline stages
    stages {
        stage('Initialize') {
            steps {
                buildDescription "#${ghprbPullId} - ${env.ghprbPullTitle}"
            }
        }
        stage('Git clone and setup') {
            when {
                allOf{
                    expression { env.GIT_BRANCH != 'master' }
                    expression { env.GIT_BRANCH != 'dev' }
                    expression { env.GIT_BRANCH != 'test' }
                }
            }
            steps {
                echo "Check out code"
                checkout scm
                script {
                    // Define a unique name for the tests container and helm release
                    RELEASE_ID = "${IMAGE_NAME}-${env.BUILD_NUMBER}"
                    echo "Global pathmind Id set to ${RELEASE_ID}"
                    echo "Merging with dev"
                    sh "cd ${WORKSPACE} && git merge origin/dev"
                }
            }
        }

        stage('Build Docker Images') {
            when {
                allOf{
                    expression { env.GIT_BRANCH != 'master' }
                    expression { env.GIT_BRANCH != 'dev' }
                    expression { env.GIT_BRANCH != 'test' }
                }
            }
            parallel {
                stage('Build pathmind image') {
                    steps {
                        buildDockerImage("${RELEASE_ID}")
                    }
                }
            }
        }

        stage('Publish Docker Images') {
            when {
                allOf{
                    expression { env.GIT_BRANCH != 'master' }
                    expression { env.GIT_BRANCH != 'dev' }
                    expression { env.GIT_BRANCH != 'test' }
                }
            }
            parallel {
                stage('Publish pathmind image') {
                    steps {
                        publishDockerImage("${RELEASE_ID}", "latest")
                    }
                }
            }
        }

        stage('Deploying helm chart') {
            when {
                allOf{
                    expression { env.GIT_BRANCH != 'master' }
                    expression { env.GIT_BRANCH != 'dev' }
                    expression { env.GIT_BRANCH != 'test' }
                }
            }
            steps {
                script {
                    echo "Creating name space ${env.BUILD_NUMBER}"
                    sh "kubectl create namespace ${env.BUILD_NUMBER}"
                    echo "Installing postgresql postgres-${env.BUILD_NUMBER}"
                    sh "helm upgrade --install postgres ${WORKSPACE}/infra/helm/postgres --set namespace=${env.BUILD_NUMBER} -n ${env.BUILD_NUMBER}"

                    echo "Waiting for psql to come up"
                    sh "timeout 900 bash -c 'while ! pg_isready  -h postgres-${env.BUILD_NUMBER} -q; do sleep 5; done'"
                }
                createSecrets()
                script {
                    echo "Creating updater resources"
                    sh "aws sqs create-queue --queue-name ${env.BUILD_ID}-updater-queue --attributes \"{\\\"MessageRetentionPeriod\\\":\\\"60\\\"}\""
                    sh "cat /tmp/sqs_policy.json | sed \"s/BUILD_ID/${env.BUILD_NUMBER}/g\" > /tmp/${env.BUILD_NUMBER}-sqs_policy.json"
                    sh "aws sqs set-queue-attributes --queue-url https://sqs.us-east-1.amazonaws.com/839270835622/${env.BUILD_NUMBER}-updater-queue --attributes file:///tmp/${env.BUILD_NUMBER}-sqs_policy.json"
                    sh "rm /tmp/${env.BUILD_NUMBER}-sqs_policy.json"
                    sh "aws sns subscribe --topic-arn arn:aws:sns:us-east-1:839270835622:dev-updater-topic --protocol sqs --notification-endpoint arn:aws:sqs:us-east-1:839270835622:${env.BUILD_ID}-updater-queue --attributes \"{\\\"RawMessageDelivery\\\":\\\"true\\\"}\""

                    echo "Creating S3 bucket for tests"
                    sh "aws s3api create-bucket --bucket ${env.BUILD_ID}-training-dynamic-files.pathmind.com --region us-east-1"


                    echo "Installing ${RELEASE_ID}"
                    sh "helm upgrade --install ${RELEASE_ID} ${WORKSPACE}/infra/helm/pathmind -f ${WORKSPACE}/infra/helm/pathmind/${HELM_FILE} --set image.repository=${DOCKER_REG}/${RELEASE_ID} --set image.tag=latest --set env.APPLICATION_URL=http://${RELEASE_ID} --set namespace=${env.BUILD_NUMBER} --set env.JOB_MOCK_CYCLE=3 --set env.SQS_UPDATER_URL=https://sqs.us-east-1.amazonaws.com/839270835622/${env.BUILD_ID}-updater-queue --set env.S3_BUCKET=${env.BUILD_ID}-training-dynamic-files.pathmind.com --set env.SNS_UPDATER_SQS_FILTER_ATTR=${env.BUILD_NUMBER}prtest -n ${env.BUILD_NUMBER}"
                    echo "Waiting for webapp to come up"
                    sh "timeout 300 bash -c 'while ! curl http://${RELEASE_ID}; do sleep 5; done'"
                    echo "Installing updater ${RELEASE_ID}"
                    sh "helm upgrade --install ${RELEASE_ID}-updater ${WORKSPACE}/infra/helm/pathmind -f ${WORKSPACE}/infra/helm/pathmind/${HELM_FILE_UPDATER} --set image.repository=${DOCKER_REG}/${RELEASE_ID} --set image.tag=latest --set env.APPLICATION_URL=http://${RELEASE_ID} --set namespace=${env.BUILD_NUMBER} --set env.JOB_MOCK_CYCLE=3 --set env.SQS_UPDATER_URL=https://sqs.us-east-1.amazonaws.com/839270835622/${env.BUILD_ID}-updater-queue --set env.S3_BUCKET=${env.BUILD_ID}-training-dynamic-files.pathmind.com --set env.SNS_UPDATER_SQS_FILTER_ATTR=${env.BUILD_NUMBER}prtest -n ${env.BUILD_NUMBER}"
                    sh "sleep 30"

                }
            }
        }

        stage('Testing') {
            when {
                allOf{
                    expression { env.GIT_BRANCH != 'master' }
                    expression { env.GIT_BRANCH != 'dev' }
                    expression { env.GIT_BRANCH != 'test' }
                }
            }
            steps {
                script {
                    try {
                        echo "Running tests"
                        TEST_STATUS = sh(returnStatus: true, script: "mvn clean verify -Dheadless=true -Denvironments.default.base.url=http://${RELEASE_ID}/ -Dpostgresql.host=postgres-${env.BUILD_NUMBER} -Dpostgresql.port=5432 -Dpostgresql.db=pathminddb -Dpostgresql.username=pathminddb -Dpostgresql.password=Asdf1234 -Dhttp.keepAlive=false -Dwebdriver.driver=remote -Dwebdriver.remote.url=http://zalenium/wd/hub -Dwebdriver.remote.driver=chrome -DforkNumber=6 -f pom.xml -P bdd-tests")
                    } catch (err) {
                    } finally {
                        publishHTML(target: [
                            reportDir: 'pathmind-bdd-tests/target/site/serenity',
                            reportFiles: 'index.html',
                            reportName: "Tests",
                            keepAll: true,
                            alwaysLinkToLastBuild: true,
                            allowMissing: false
                        ])
                    }

                }
            }
        }
        stage('Set pipeline status') {
            when {
                allOf{
                    expression { env.GIT_BRANCH != 'master' }
                    expression { env.GIT_BRANCH != 'dev' }
                    expression { env.GIT_BRANCH != 'test' }
                }
            }
            steps {
                script {
                    if (TEST_STATUS != 0) {
                        echo "Some bdd tests failed ${TEST_STATUS}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
    }
    post {
        always {
            echo 'Deleting workspace'
            deleteDir()
            echo "Deleting image"
            deleteDockerImage("${RELEASE_ID}")
            echo "Deleting name space ${env.BUILD_NUMBER}"
            sh "helm delete postgres -n ${env.BUILD_NUMBER}"
            sh "helm delete ${RELEASE_ID} -n ${env.BUILD_NUMBER}"
            sh "helm delete ${RELEASE_ID}-updater -n ${env.BUILD_NUMBER}"
            sh "kubectl delete namespace ${env.BUILD_NUMBER}"
            sh "aws sqs delete-queue --queue-url https://sqs.us-east-1.amazonaws.com/839270835622/${env.BUILD_NUMBER}-updater-queue"
            sh "aws sns unsubscribe --subscription-arn `aws sns list-subscriptions | jq -r \".[] | .[] |  select(.Endpoint ==\\\"arn:aws:sqs:us-east-1:839270835622:${env.BUILD_ID}-updater-queue\\\").SubscriptionArn\"`"
            sh "/usr/bin/clean_test_s3.sh ${env.BUILD_NUMBER}"
        }
    }
}

